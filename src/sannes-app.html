<link rel="import" href="/bower_components/polymer/polymer-element.html">
<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="/bower_components/paper-styles/shadow.html">
<link rel="import" href="/bower_components/paper-styles/color.html">
<link rel="import" href="/bower_components/paper-checkbox/paper-checkbox.html">

<link rel="import" href="sannes-group.html">
<link rel="import" href="sannes-filter.html">

<dom-module id="sannes-app">
  <template>
    <style>
      :host {
        display: block;
      }

      #header{
        width:100%;
        height:103px;
        line-height: 103px;
        background-color: #44aedb;
      }

      #header > h1{
        color:white;
        text-align: center;
        margin:0;
      }

      #content{
        padding: 8px;
      }


      footer > h4{
        text-align:center;
      }

      .flexContainer{
        width: 100%;
        display: flex;
        flex-wrap: wrap;
        justify-content: flex-start;
      }

      .hidden{
        display: none !important;
      }

    </style>

    <iron-ajax auto url="../data/pizza.json" handle-as="json" last-response="{{ajaxResponse}}" on-response="_ajaxReponseUpdated"></iron-ajax>

    <div id="header">
      <h1>üçïSannes</h1>
    </div>

    <div id="content">
      <div id="filter">
        <sannes-filter id="filter" show-pizzas={{showPizzas}} ingredients="{{allIngredients}}" item-filters="{{itemFilters}}" max-cost="{{maxCost}}"></sannes-filter>
      </div>
      <h1 id="resultHeader" class="hidden">Resultat:</h1>

      <div id="resultContainer" class="flexContainer hidden">
        <template is="dom-repeat" items="[[allItems]]">
          <sannes-item item-name="[[item.name]]" item-data="[[item.value]]" item-filters=[[itemFilters]] max-cost="[[maxCost]]"></sannes-item>
        </template>
      </div>

      <div id="pizzasContainer">
        <template is="dom-repeat" items="[[_toArray(ajaxResponse.pizzas)]]">
          <sannes-group group-name="Pizzagrupp [[item.name]]" group-data="[[item.value]]" item-filters=[[itemFilters]] max-cost="[[maxCost]]"></sannes-group>
        </template>
      </div>

      <div id="otherContainer">
        <template is="dom-repeat" items="[[others]]">
          <sannes-group group-name="[[item.name]]" group-data="[[item.value]]" item-filters="[[itemFilters]]" max-cost="[[maxCost]]"></sannes-group>
        </template>
      </div>
    </div>

    <footer>
      <h4>Think with Portals ‚ù§</h4>
    </footer>

  </template>
  <script>

    class SannesApp extends Polymer.Element {
      static get is() { return 'sannes-app'; }
      static get properties() {
        return {
          ajaxResponse:{
            type: Object,
            notify: true
          },
          others:{
            type: Array,
            notify: true,
          },
          showPizzas:{
            type: Boolean,
            notify: true,
            observer: '_showPizzasUpdated'
          },
          allIngredients:{
            type: Array,
            notify: true,
          },
          itemFilters:{
            type: Array,
            notify: true,
          },
          maxCost:{
            type: Number,
            notify: true,
            value: NaN
          },
          allItems:{
            type: Array,
            value: function(){
              return []
            }
          }
        };
      }

      static get observers() {
        return [
          '_updateResultHeaderHidden(itemFilters.splices)',
          '_updateResultHeaderHidden(maxCost)'
        ]
      }

      ready(){
        super.ready();
        this._updateResultHeaderHidden();
      }

      _updateResultHeaderHidden(){
        if(this.itemFilters.length > 0 || !isNaN(this.maxCost)){
          this.$.resultContainer.classList.remove("hidden");
          this.$.resultHeader.classList.remove("hidden");
          this.$.pizzasContainer.classList.add("hidden");
          this.$.otherContainer.classList.add("hidden");
        }else{
          this.$.resultContainer.classList.add("hidden");
          this.$.resultHeader.classList.add("hidden");
          this.$.pizzasContainer.classList.remove("hidden");
          this.$.otherContainer.classList.remove("hidden");
        }
      }

      _ajaxReponseUpdated(){
        if(this.ajaxResponse == null){
          return;
        }

        this.set('allItems', this._getAllItems());
        this.set('others', this._toArray(this._getOtherItemGroups()));
        this.set('allIngredients', this._getEveryUniqueIngredient(this.ajaxResponse));

      }

      _getAllItems(){
        var allItems = {};
        var allGroups = this._getOtherItemGroups();

        for(var pizzaGroupIndex in this.ajaxResponse.pizzas){
          allGroups[pizzaGroupIndex] = this.ajaxResponse.pizzas[pizzaGroupIndex];
        }

        for(var groupIndex in allGroups){
          for(var itemName in allGroups[groupIndex]){
            allItems[itemName] = (allGroups[groupIndex][itemName]);
          }
        }

        return this._toArray(allItems);
      }

      _getOtherItemGroups(){
          var outputObject = {};
          outputObject["Kebabrullar"] = this.ajaxResponse["kebab rolls"];
          outputObject["Hamburgare"] = this.ajaxResponse["hamburgers"];
          outputObject["Grillat"] = this.ajaxResponse["roasts"];
          outputObject["Pasta"] = this.ajaxResponse["pastas"];
          return outputObject;
      }

      _getEveryUniqueIngredient(data){
        return this._removeDuplicates(this._mergeToOneArray(this._getAllIngredients(data)));
      }

      _removeDuplicates(array){
        return array.filter( function( item, index, inputArray ) {
           return inputArray.indexOf(item) == index;
         });
      }

      _mergeToOneArray(array) {
        var  output = [];

        array.forEach(item => {
          if (Array.isArray(item)) {
            output.push(...this._mergeToOneArray(item));
          } else {
            output.push(item);
          }
        });

        return output;
      }

      _getAllIngredients(data){
        var output = [];

        for(var index in data){
          if(data.hasOwnProperty(index) && data[index] instanceof Object) {
            if(index == "ingredients"){
              output.push(data[index]);
            }else{
              output.push(this._getAllIngredients(data[index]));
            }
          }
        }

        return output;
      }

      _toArray(obj){
        if(obj == null){
          return [];
        }

        return Object.keys(obj).map(function(key){
          return {
            name: key,
            value: obj[key]
          }
        });
      }

      _showPizzasUpdated(){
        if(!this.showPizzas){
          this.$.pizzasContainer.classList.add("hidden");
        }else{
          this.$.pizzasContainer.classList.remove("hidden");
        }
      }
    }

    window.customElements.define(SannesApp.is, SannesApp);
  </script>
</dom-module>
